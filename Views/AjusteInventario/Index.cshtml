@model PitStop_Parts_Inventario.Models.ViewModels.PagedResult<PitStop_Parts_Inventario.Models.AjusteInventarioModel>
@{
    ViewData["Title"] = "Ajuste de Inventario";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/assets/css/ajuste-inventario.css" asp-append-version="true" />
}

<section class="header">
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h2 class="header-title">Ajuste de Inventario</h2>
            <p class="text-muted header-subtitle">Corrección y ajuste de cantidades en stock</p>
        </div>
    </div>
</section>

<!-- Search and Actions Section -->
<section class="search-actions-section mb-4">
    <form method="get" asp-action="Index" id="filtrosForm">
        <div class="row">
            <div class="col-md-4">
                <div class="input-group">
                    <input type="text" name="filtros.SearchTerm" class="form-control" placeholder="Buscar ajuste..." value="@ViewBag.SearchTerm">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
            </div>
            <div class="col-md-3">
                <select name="filtros.TipoAjuste" class="form-select" onchange="document.getElementById('filtrosForm').submit();">
                    <option value="">Todos los tipos</option>
                    <option value="aumento" selected="@(ViewBag.TipoAjuste == "aumento" ? "selected" : null)">Aumento</option>
                    <option value="disminucion" selected="@(ViewBag.TipoAjuste == "disminucion" ? "selected" : null)">Disminución</option>
                    <option value="correccion" selected="@(ViewBag.TipoAjuste == "correccion" ? "selected" : null)">Corrección</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" name="filtros.FechaFiltro" class="form-control" value="@ViewBag.FechaFiltro">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#nuevoAjusteModal">
                    <i class="fas fa-plus me-2"></i>Nuevo Ajuste
                </button>
            </div>
        </div>
        <input type="hidden" name="numeroPagina" value="@Model.PageNumber" />
    </form>
</section>

<!-- Adjustments Table Section -->
<section class="adjustments-table-section">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Historial de Ajustes</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-download me-1"></i>Exportar
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-filter me-1"></i>Filtros
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Nº Ajuste</th>
                            <th>Fecha</th>
                            <th>Bodega</th>
                            <th>Usuario</th>
                            <th>Total Productos</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Data.Any())
                        {
                            @foreach (var ajuste in Model.Data)
                            {
                                <tr>
                                    <td><strong>AJU-@ajuste.IdAjusteInventario</strong></td>
                                    <td>@ajuste.Fecha.ToString("dd/MM/yyyy")</td>
                                    <td>@(ajuste.Bodega?.Nombre ?? "N/A")</td>
                                    <td>@(ajuste.Usuario?.UserName ?? "N/A")</td>
                                    <td><span class="badge bg-info">@(ajuste.AjusteInventarioProductos?.Count ?? 0)</span></td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" title="Ver detalles" onclick="abrirModalVisualizarAjuste('@ajuste.IdAjusteInventario')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" title="Editar" onclick="abrirModalEditarAjuste('@ajuste.IdAjusteInventario')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="abrirModalEliminarAjuste('@ajuste.IdAjusteInventario')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="fas fa-search fa-2x mb-2"></i>
                                    <p class="mb-0">No se encontraron ajustes con los criterios especificados.</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Section -->
            @if (Model.TotalPages > 1)
            {
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span class="text-muted">
                            Mostrando página @Model.PageNumber de @Model.TotalPages 
                            (Total: @Model.TotalRecords ajustes)
                        </span>
                    </div>
                    <nav aria-label="Paginación de ajustes">
                        <ul class="pagination mb-0">
                            @if (Model.PageNumber > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="?numeroPagina=@(Model.PageNumber - 1)&filtros.SearchTerm=@ViewBag.SearchTerm&filtros.TipoAjuste=@ViewBag.TipoAjuste&filtros.FechaFiltro=@ViewBag.FechaFiltro">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            }
                            
                            @for (int i = Math.Max(1, Model.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.PageNumber + 2); i++)
                            {
                                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                    <a class="page-link" href="?numeroPagina=@i&filtros.SearchTerm=@ViewBag.SearchTerm&filtros.TipoAjuste=@ViewBag.TipoAjuste&filtros.FechaFiltro=@ViewBag.FechaFiltro">@i</a>
                                </li>
                            }
                            
                            @if (Model.PageNumber < Model.TotalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="?numeroPagina=@(Model.PageNumber + 1)&filtros.SearchTerm=@ViewBag.SearchTerm&filtros.TipoAjuste=@ViewBag.TipoAjuste&filtros.FechaFiltro=@ViewBag.FechaFiltro">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
</section>

<!-- Add Adjustment Modal -->
<div class="modal fade" id="addAdjustmentModal" tabindex="-1" aria-labelledby="addAdjustmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAdjustmentModalLabel">Nuevo Ajuste de Inventario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <!-- Adjustment Header -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="adjustmentNumber" class="form-label">Número de Ajuste</label>
                            <input type="text" class="form-control" id="adjustmentNumber" value="AJU-005" readonly>
                        </div>
                        <div class="col-md-4">
                            <label for="adjustmentDate" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="adjustmentDate" value="@DateTime.Now.ToString("yyyy-MM-dd")" required>
                        </div>
                        <div class="col-md-4">
                            <label for="adjustmentType" class="form-label">Tipo de Ajuste</label>
                            <select class="form-select" id="adjustmentType" required>
                                <option value="">Seleccionar tipo...</option>
                                <option value="aumento">Aumento</option>
                                <option value="disminucion">Disminución</option>
                                <option value="correccion">Corrección</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Product Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="adjustmentProduct" class="form-label">Producto</label>
                            <select class="form-select" id="adjustmentProduct" required>
                                <option value="">Seleccionar producto...</option>
                                <option value="1" data-current-stock="25">Filtro de Aire Premium (Stock: 25)</option>
                                <option value="2" data-current-stock="5">Pastillas de Freno Delanteras (Stock: 5)</option>
                                <option value="3" data-current-stock="0">Aceite Motor 5W-30 (Stock: 0)</option>
                                <option value="4" data-current-stock="20">Amortiguador Delantero (Stock: 20)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="adjustmentWarehouse" class="form-label">Bodega</label>
                            <select class="form-select" id="adjustmentWarehouse" required>
                                <option value="">Seleccionar bodega...</option>
                                <option value="1">Bodega Principal</option>
                                <option value="2">Bodega Norte</option>
                                <option value="3">Bodega Sur</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Stock Information -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Información de Stock</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="currentStock" class="form-label">Stock Actual</label>
                                            <input type="number" class="form-control" id="currentStock" readonly>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="adjustmentQuantity" class="form-label">Cantidad a Ajustar</label>
                                            <div class="input-group">
                                                <span class="input-group-text" id="adjustmentSign">+</span>
                                                <input type="number" class="form-control" id="adjustmentQuantity" min="1" required>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="newStock" class="form-label">Nuevo Stock</label>
                                            <input type="number" class="form-control" id="newStock" readonly>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="stockDifference" class="form-label">Diferencia</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="stockDifference" readonly>
                                                <span class="input-group-text">unidades</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reason and Notes -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="adjustmentReason" class="form-label">Motivo del Ajuste</label>
                            <select class="form-select" id="adjustmentReason" required>
                                <option value="">Seleccionar motivo...</option>
                                <option value="inventario_fisico">Inventario físico</option>
                                <option value="mercancia_encontrada">Mercancía encontrada</option>
                                <option value="producto_danado">Producto dañado</option>
                                <option value="producto_vencido">Producto vencido</option>
                                <option value="robo_perdida">Robo/Pérdida</option>
                                <option value="error_sistema">Error de sistema</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="adjustmentCost" class="form-label">Costo Unitario (Opcional)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="adjustmentCost" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="adjustmentNotes" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="adjustmentNotes" rows="3" placeholder="Descripción detallada del motivo del ajuste..." required></textarea>
                    </div>
                    
                    <!-- Approval Section -->
                    <div class="mb-3">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atención:</strong> Este ajuste modificará el stock del producto seleccionado. Verifique todos los datos antes de confirmar.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning">Guardar como Borrador</button>
                <button type="button" class="btn btn-primary">Aplicar Ajuste</button>
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

<section class="modal-container">
<!-- Modal Nuevo Ajuste -->
<div class="modal fade" id="nuevoAjusteModal" tabindex="-1" aria-labelledby="nuevoAjusteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="nuevoAjusteModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Nuevo Ajuste de Inventario
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="nuevoAjusteForm">
                    <!-- Información general -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <label for="bodegaAjuste" class="form-label">Bodega</label>
                            <div class="input-group">
                                <select class="form-select" id="bodegaAjuste" name="bodega_id" required>
                                    <option value="">Seleccionar bodega</option>
                                </select>
                                <span class="input-group-text"><i class="fas fa-warehouse"></i></span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fechaAjuste" class="form-label">Fecha de Ajuste</label>
                            <input type="date" class="form-control" id="fechaAjuste" name="fecha" required>
                        </div>
                    </div>
                    <!-- Selección de productos -->
                    <div class="row mb-3">
                        <div class="col-lg-8 col-12">
                            <label for="productoAjuste" class="form-label">Agregar Producto</label>
                            <select class="form-select" id="productoAjuste">
                                <option value="">Seleccionar producto</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-6 mt-lg-0 mt-3">
                            <label for="cantidadAjuste" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="cantidadAjuste" placeholder="0" min="1">
                        </div>
                        <div class="col-lg-2 col-6 d-flex align-items-end mt-lg-0 mt-3">
                            <button type="button" class="btn btn-success w-100" style="height: 50px;" onclick="agregarProductoAjuste('agregar')">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        </div>
                    </div>
                    <!-- Tabla de productos -->
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad Nueva</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaProductosAjuste">
                                <tr class="text-center">
                                    <td colspan="3" class="text-white">No hay productos agregados</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="guardarAjuste()">
                    <i class="fas fa-save me-1"></i>Guardar Ajuste
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Editar Ajuste -->
<div class="modal fade" id="editarAjusteModal" tabindex="-1" aria-labelledby="editarAjusteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="editarAjusteModalLabel">
                    <i class="fas fa-edit me-2"></i>Editar Ajuste de Inventario
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editarAjusteForm">
                    <!-- Información general -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <label for="editBodegaAjuste" class="form-label">Bodega</label>
                            <div class="input-group">
                                <select class="form-select" id="editBodegaAjuste" name="bodega_id" required>
                                    <option value="">Seleccionar bodega</option>
                                </select>
                                <span class="input-group-text"><i class="fas fa-warehouse"></i></span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editFecha" class="form-label">Fecha de Ajuste</label>
                            <input type="date" class="form-control" id="editFechaAjuste" name="fecha" value="2024-03-15" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editEstadoAjuste" class="form-label">Estado</label>
                            <select class="form-select" id="editEstadoAjuste" name="estado_id" required>
                                <option value="">Seleccionar estado</option>
                            </select>
                        </div>
                    </div>
                    <!-- Selección de productos -->
                    <div class="row mb-3">
                        <div class="col-lg-8 col-12">
                            <label for="editProductoAjuste" class="form-label">Agregar Producto</label>
                            <select class="form-select" id="editProductoAjuste">
                                <option value="">Seleccionar producto</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-6 mt-lg-0 mt-3">
                            <label for="editCantidadAjuste" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="editCantidadAjuste" placeholder="0" min="1">
                        </div>
                        <div class="col-lg-2 col-6 d-flex align-items-end mt-lg-0 mt-3">
                            <button type="button" class="btn btn-success w-100" style="height: 50px;" onclick="agregarProductoAjuste('editar')">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        </div>
                    </div>
                    <!-- Tabla de productos -->
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad Nueva</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="editTablaProductosAjuste">
                                <tr class="text-center">
                                    <td colspan="3" class="text-white">No hay productos agregados</td>
                                </tr>
                                <!-- Los productos se cargan dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="actualizarAjuste()">
                    <i class="fas fa-save me-1"></i>Actualizar Ajuste
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Visualizar Ajuste -->
<div class="modal fade" id="visualizarAjusteModal" tabindex="-1" aria-labelledby="visualizarAjusteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="visualizarAjusteModalLabel">
                    <i class="fas fa-eye me-2 text-info"></i>Detalles del Ajuste de Inventario
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="product-info">
                            <div class="product-info-label">Bodega</div>
                            <p class="product-info-value" id="visualizarBodegaAjuste">Cargando...</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="product-info">
                            <div class="product-info-label">Fecha de Ajuste</div>
                            <p class="product-info-value" id="visualizarFechaAjuste">Cargando...</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="product-info">
                            <div class="product-info-label">Estado</div>
                            <p class="product-info-value">
                                <span class="badge bg-success fs-6" id="visualizarEstadoAjuste">Cargando...</span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="product-info">
                            <div class="product-info-label">Total de Productos</div>
                            <p class="product-info-value" id="visualizarTotalProductosAjuste">Cargando...</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="product-info">
                            <div class="product-info-label">Usuario Responsable</div>
                            <p class="product-info-value" id="visualizarUsuarioAjuste">Cargando...</p>
                        </div>
                    </div>
                </div>
                <!-- Tabla de productos ajustados -->
                <h5 class="text-white mb-3">Productos Ajustados</h5>
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad Anterior</th>
                                <th>Cantidad Nueva</th>
                                <th>Diferencia</th>
                            </tr>
                        </thead>
                        <tbody id="visualizarTablaProductosAjuste">
                            <!-- Los productos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#editarAjusteModal">
                    <i class="fas fa-edit me-1"></i>Editar Ajuste
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Eliminar Ajuste -->
<div class="modal fade" id="eliminarAjusteModal" tabindex="-1" aria-labelledby="eliminarAjusteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="eliminarAjusteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Eliminar Ajuste de Inventario
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>¡Atención!</strong> Esta acción no se puede deshacer y afectará el inventario.
                </div>
                <p class="text-white mb-3">¿Está seguro que desea eliminar el siguiente ajuste de inventario?</p>
                <div class="bg-dark p-3 rounded">
                    <p class="text-white mb-1"><strong>Fecha:</strong> <span id="eliminarFechaAjuste">-</span></p>
                    <p class="text-white mb-1"><strong>Bodega:</strong> <span id="eliminarBodegaAjuste">-</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="eliminarAjuste()">
                    <i class="fas fa-trash me-1"></i>Eliminar Ajuste
                </button>
            </div>
        </div>
    </div>
</div>
</section>

@section Scripts {
    <script>
        // Adjustment calculation functionality
        function updateAdjustmentCalculations() {
            const currentStock = parseInt(document.getElementById('currentStock').value) || 0;
            const adjustmentQuantity = parseInt(document.getElementById('adjustmentQuantity').value) || 0;
            const adjustmentType = document.getElementById('adjustmentType').value;
            
            let newStock = currentStock;
            let difference = 0;
            let sign = '+';
            
            if (adjustmentType === 'aumento') {
                newStock = currentStock + adjustmentQuantity;
                difference = adjustmentQuantity;
                sign = '+';
            } else if (adjustmentType === 'disminucion') {
                newStock = Math.max(0, currentStock - adjustmentQuantity);
                difference = -adjustmentQuantity;
                sign = '-';
            } else if (adjustmentType === 'correccion') {
                newStock = adjustmentQuantity;
                difference = adjustmentQuantity - currentStock;
                sign = difference >= 0 ? '+' : '';
            }
            
            document.getElementById('newStock').value = newStock;
            document.getElementById('stockDifference').value = difference;
            document.getElementById('adjustmentSign').textContent = sign;
        }
        
        // Product selection handler
        document.getElementById('adjustmentProduct').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const currentStock = selectedOption.getAttribute('data-current-stock') || 0;
            document.getElementById('currentStock').value = currentStock;
            updateAdjustmentCalculations();
        });
        
        // Adjustment type change handler
        document.getElementById('adjustmentType').addEventListener('change', function() {
            updateAdjustmentCalculations();
            
            // Update quantity input behavior based on type
            const quantityInput = document.getElementById('adjustmentQuantity');
            if (this.value === 'correccion') {
                quantityInput.placeholder = 'Cantidad final deseada';
            } else {
                quantityInput.placeholder = 'Cantidad a ajustar';
            }
        });
        
        // Quantity change handler
        document.getElementById('adjustmentQuantity').addEventListener('input', function() {
            updateAdjustmentCalculations();
        });
        
        // Initialize calculations
        updateAdjustmentCalculations();
    </script>
}
