@{
    ViewData["Title"] = "Entrada de Productos";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/assets/css/entrada-producto.css" asp-append-version="true" />
}

<section class="header">
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h2 class="header-title">Entrada de Productos</h2>
            <p class="text-muted header-subtitle">Registro de ingresos de mercancía al inventario</p>
        </div>
    </div>
</section>

<!-- Search and Actions Section -->
<section class="search-actions-section mb-4">
    <div class="row">
        <div class="col-md-4">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Buscar entrada...">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select">
                <option value="" selected>Todas las bodegas</option>
                <option value="principal">Bodega Principal</option>
                <option value="norte">Bodega Norte</option>
                <option value="sur">Bodega Sur</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="date" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#nuevaEntradaModal">
                <i class="fas fa-plus me-2"></i>Nueva Entrada
            </button>
        </div>
    </div>
</section>

<!-- Entries Table Section -->
<section class="entries-table-section">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Historial de Entradas</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-download me-1"></i>Exportar
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-filter me-1"></i>Filtros
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Nº Entrada</th>
                            <th>Fecha</th>
                            <th>Proveedor</th>
                            <th>Bodega</th>
                            <th>Productos</th>
                            <th>Total Items</th>
                            <th>Valor Total</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>ENT-001</strong></td>
                            <td>24/07/2025</td>
                            <td>AutoParts Supply Co.</td>
                            <td>Bodega Principal</td>
                            <td>5</td>
                            <td><span class="badge bg-info">120</span></td>
                            <td><strong>$2,450.00</strong></td>
                            <td>Juan Pérez</td>
                            <td><span class="badge bg-success">Completada</span></td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" title="Ver detalles" onclick="abrirModalVisualizarEntrada('ENT-001')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" title="Editar" onclick="abrirModalEditarEntrada('ENT-001')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="abrirModalEliminarEntrada('ENT-001')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>ENT-002</strong></td>
                            <td>23/07/2025</td>
                            <td>BrakeTech Industries</td>
                            <td>Bodega Norte</td>
                            <td>3</td>
                            <td><span class="badge bg-info">75</span></td>
                            <td><strong>$1,890.00</strong></td>
                            <td>María García</td>
                            <td><span class="badge bg-warning">En Proceso</span></td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" title="Ver detalles" onclick="abrirModalVisualizarEntrada('ENT-002')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" title="Editar" onclick="abrirModalEditarEntrada('ENT-002')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="abrirModalEliminarEntrada('ENT-002')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>ENT-003</strong></td>
                            <td>22/07/2025</td>
                            <td>MotorOil Solutions</td>
                            <td>Bodega Principal</td>
                            <td>2</td>
                            <td><span class="badge bg-info">50</span></td>
                            <td><strong>$875.00</strong></td>
                            <td>Carlos López</td>
                            <td><span class="badge bg-success">Completada</span></td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" title="Ver detalles" onclick="abrirModalVisualizarEntrada('ENT-003')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" title="Editar" onclick="abrirModalEditarEntrada('ENT-003')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="abrirModalEliminarEntrada('ENT-003')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Add Entry Modal -->
<div class="modal fade" id="addEntryModal" tabindex="-1" aria-labelledby="addEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEntryModalLabel">Nueva Entrada de Productos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <!-- Entry Header -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="entryNumber" class="form-label">Número de Entrada</label>
                            <input type="text" class="form-control" id="entryNumber" value="ENT-004" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="entryDate" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="entryDate" value="@DateTime.Now.ToString("yyyy-MM-dd")" required>
                        </div>
                        <div class="col-md-3">
                            <label for="entrySupplier" class="form-label">Proveedor</label>
                            <select class="form-select" id="entrySupplier" required>
                                <option value="">Seleccionar proveedor...</option>
                                <option value="1">AutoParts Supply Co.</option>
                                <option value="2">BrakeTech Industries</option>
                                <option value="3">MotorOil Solutions</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="entryWarehouse" class="form-label">Bodega</label>
                            <select class="form-select" id="entryWarehouse" required>
                                <option value="">Seleccionar bodega...</option>
                                <option value="1">Bodega Principal</option>
                                <option value="2">Bodega Norte</option>
                                <option value="3">Bodega Sur</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Products Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Productos</h6>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addProductRow">
                                <i class="fas fa-plus me-1"></i>Agregar Producto
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered" id="productsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 30%;">Producto</th>
                                        <th style="width: 15%;">Cantidad</th>
                                        <th style="width: 15%;">Precio Unitario</th>
                                        <th style="width: 15%;">Subtotal</th>
                                        <th style="width: 20%;">Lote/Vencimiento</th>
                                        <th style="width: 5%;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <select class="form-select form-select-sm">
                                                <option value="">Seleccionar producto...</option>
                                                <option value="1">Filtro de Aire Premium</option>
                                                <option value="2">Pastillas de Freno</option>
                                                <option value="3">Aceite Motor 5W-30</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm quantity-input" min="1" value="1">
                                        </td>
                                        <td>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control price-input" step="0.01" min="0">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control subtotal-input" step="0.01" readonly>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" placeholder="Lote/Fecha">
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-row">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Totals Section -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="entryNotes" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="entryNotes" rows="3" placeholder="Notas adicionales sobre la entrada..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span>Total Items:</span>
                                        <strong id="totalItems">0</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Subtotal:</span>
                                        <strong id="subtotalAmount">$0.00</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>IVA (19%):</span>
                                        <strong id="taxAmount">$0.00</strong>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <span><strong>Total:</strong></span>
                                        <strong class="text-primary" id="totalAmount">$0.00</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning">Guardar como Borrador</button>
                <button type="button" class="btn btn-primary">Confirmar Entrada</button>
            </div>
        </div>
    </div>
</div>

<section class="modal-container">
<!-- Modal Nueva Entrada -->
<div class="modal fade" id="nuevaEntradaModal" tabindex="-1" aria-labelledby="nuevaEntradaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="nuevaEntradaModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Nueva Entrada de Producto
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="nuevaEntradaForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productoEntrada" class="form-label">Producto</label>
                            <div class="input-group">
                                <select class="form-select" id="productoEntrada" name="producto_id" required>
                                    <option value="">Seleccionar producto</option>
                                </select>
                                <span class="input-group-text"><i class="fas fa-box"></i></span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bodegaEntrada" class="form-label">Bodega</label>
                            <div class="input-group">
                                <select class="form-select" id="bodegaEntrada" name="bodega_id" required>
                                    <option value="">Seleccionar bodega</option>
                                </select>
                                <span class="input-group-text"><i class="fas fa-warehouse"></i></span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cantidadEntrada" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="cantidadEntrada" name="cantidad" placeholder="0" min="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fechaIngresoEntrada" class="form-label">Fecha de Ingreso</label>
                            <input type="date" class="form-control" id="fechaIngresoEntrada" name="fecha_ingreso" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="guardarEntrada()">
                    <i class="fas fa-save me-1"></i>Guardar Entrada
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Editar Entrada -->
<div class="modal fade" id="editarEntradaModal" tabindex="-1" aria-labelledby="editarEntradaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="editarEntradaModalLabel">
                    <i class="fas fa-edit me-2"></i>Editar Entrada de Producto
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editarEntradaForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editProductoEntrada" class="form-label">Producto</label>
                            <div class="input-group">
                                <select class="form-select" id="editProductoEntrada" name="producto_id" required>
                                    <option value="">Seleccionar producto</option>
                                </select>
                                <span class="input-group-text"><i class="fas fa-box"></i></span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editBodegaEntrada" class="form-label">Bodega</label>
                            <div class="input-group">
                                <select class="form-select" id="editBodegaEntrada" name="bodega_id" required>
                                    <option value="">Seleccionar bodega</option>
                                </select>
                                <span class="input-group-text"><i class="fas fa-warehouse"></i></span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCantidadEntrada" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="editCantidadEntrada" name="cantidad" min="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editFechaIngresoEntrada" class="form-label">Fecha de Ingreso</label>
                            <input type="date" class="form-control" id="editFechaIngresoEntrada" name="fecha_ingreso" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editEstadoEntrada" class="form-label">Estado</label>
                            <select class="form-select" id="editEstadoEntrada" name="estado_id" required>
                                <option value="">Seleccionar estado</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="actualizarEntrada()">
                    <i class="fas fa-save me-1"></i>Actualizar Entrada
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Visualizar Entrada -->
<div class="modal fade" id="visualizarEntradaModal" tabindex="-1" aria-labelledby="visualizarEntradaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="visualizarEntradaModalLabel">
                    <i class="fas fa-eye me-2 text-info"></i>Detalles de la Entrada
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="product-info">
                            <div class="product-info-label">Producto</div>
                            <p class="product-info-value" id="visualizarProductoEntrada">Cargando...</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="product-info">
                            <div class="product-info-label">Bodega</div>
                            <p class="product-info-value" id="visualizarBodegaEntrada">Cargando...</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="product-info">
                            <div class="product-info-label">Cantidad Ingresada</div>
                            <p class="product-info-value" id="visualizarCantidadEntrada">Cargando...</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="product-info">
                            <div class="product-info-label">Fecha de Ingreso</div>
                            <p class="product-info-value" id="visualizarFechaIngresoEntrada">Cargando...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Información adicional -->
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="product-info">
                            <div class="product-info-label">Estado</div>
                            <p class="product-info-value">
                                <span class="badge bg-success fs-6" id="visualizarEstadoEntrada">Cargando...</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="product-info">
                            <div class="product-info-label">Usuario</div>
                            <p class="product-info-value">
                                <span class="badge bg-info text-dark fs-6" id="visualizarUsuarioEntrada">Cargando...</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="product-info">
                            <div class="product-info-label">Hora de Registro</div>
                            <p class="product-info-value" id="visualizarHoraEntrada">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#editarEntradaModal">
                    <i class="fas fa-edit me-1"></i>Editar Entrada
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Eliminar Entrada -->
<div class="modal fade" id="eliminarEntradaModal" tabindex="-1" aria-labelledby="eliminarEntradaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="eliminarEntradaModalLabel">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Eliminar Entrada
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>¡Atención!</strong> Esta acción no se puede deshacer y afectará el inventario.
                </div>
                <p class="text-white mb-3">¿Está seguro que desea eliminar la siguiente entrada?</p>
                <div class="bg-dark p-3 rounded">
                    <p class="text-white mb-1"><strong>Producto:</strong> <span id="eliminarProductoEntrada">-</span></p>
                    <p class="text-white mb-0"><strong>Cantidad:</strong> <span id="eliminarCantidadEntrada">-</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="eliminarEntrada()">
                    <i class="fas fa-trash me-1"></i>Eliminar Entrada
                </button>
            </div>
        </div>
    </div>
</div>
</section>

@section Scripts {
    <script>
        // Product table functionality
        function calculateSubtotal(row) {
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const subtotal = quantity * price;
            row.querySelector('.subtotal-input').value = subtotal.toFixed(2);
            calculateTotals();
        }
        
        function calculateTotals() {
            const subtotalInputs = document.querySelectorAll('.subtotal-input');
            let totalItems = 0;
            let subtotalAmount = 0;
            
            subtotalInputs.forEach(input => {
                const row = input.closest('tr');
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const subtotal = parseFloat(input.value) || 0;
                
                totalItems += quantity;
                subtotalAmount += subtotal;
            });
            
            const taxAmount = subtotalAmount * 0.19;
            const totalAmount = subtotalAmount + taxAmount;
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('subtotalAmount').textContent = '$' + subtotalAmount.toFixed(2);
            document.getElementById('taxAmount').textContent = '$' + taxAmount.toFixed(2);
            document.getElementById('totalAmount').textContent = '$' + totalAmount.toFixed(2);
        }
        
        // Event listeners
        document.getElementById('productsTable').addEventListener('input', function(e) {
            if (e.target.classList.contains('quantity-input') || e.target.classList.contains('price-input')) {
                calculateSubtotal(e.target.closest('tr'));
            }
        });
        
        document.getElementById('addProductRow').addEventListener('click', function() {
            const tbody = document.querySelector('#productsTable tbody');
            const newRow = tbody.firstElementChild.cloneNode(true);
            
            // Clear values
            newRow.querySelectorAll('input, select').forEach(input => {
                input.value = '';
            });
            
            tbody.appendChild(newRow);
        });
        
        document.getElementById('productsTable').addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-row') || e.target.closest('.remove-row')) {
                const tbody = document.querySelector('#productsTable tbody');
                if (tbody.children.length > 1) {
                    e.target.closest('tr').remove();
                    calculateTotals();
                }
            }
        });
    </script>
}
